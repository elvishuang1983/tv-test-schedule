<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»è¦–ç”¢å“æ¸¬è©¦å®‰æ’</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h2>é›»è¦–ç”¢å“æ¸¬è©¦å®‰æ’</h2>
    
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">ä¸Šå‚³ Excel</button>
    <p id="uploadStatus"></p> <!-- é¡¯ç¤ºä¸Šå‚³ç‹€æ…‹ -->

    <h3>é¸æ“‡è®Šæ›´ææ–™</h3>
    <input type="text" id="materialInput" oninput="matchMaterial()" placeholder="è¼¸å…¥è®Šæ›´ææ–™">
    <select id="materialSelect"></select>
    <button onclick="calculateTests()">è¨ˆç®—æ¸¬è©¦éœ€æ±‚</button>

    <h3>æ¸¬è©¦å®‰æ’çµæœ</h3>
    <table border="1" id="testResults">
        <tr>
            <th>æ¸¬è©¦éƒ¨é–€</th>
            <th>æ‰€éœ€æ¨£æ©Ÿæ•¸</th>
        </tr>
    </table>
    
    <script>
        let materials = [];

        function uploadFile() {
            let fileInput = document.getElementById('fileInput');
            let file = fileInput.files[0];

            if (!file) {
                document.getElementById('uploadStatus').textContent = "âŒ è«‹é¸æ“‡è¦ä¸Šå‚³çš„ Excel æª”æ¡ˆï¼";
                document.getElementById('uploadStatus').style.color = "red";
                return;
            }

            let formData = new FormData();
            formData.append('file', file);
            
            $.ajax({
                url: 'http://127.0.0.1:5000/upload',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    console.log("âœ… ä¼ºæœå™¨å›æ‡‰:", response);
                    document.getElementById('uploadStatus').textContent = `âœ… æ–‡ä»¶ "${file.name}" ä¸Šå‚³æˆåŠŸï¼`;
                    document.getElementById('uploadStatus').style.color = "green";
                    
                    materials = response.change_materials;
                    let select = document.getElementById('materialSelect');
                    select.innerHTML = '';

                    if (materials.length === 0) {
                        document.getElementById('uploadStatus').textContent += " âš ï¸ ä½†æœªæ‰¾åˆ°è®Šæ›´ææ–™ï¼";
                        document.getElementById('uploadStatus').style.color = "orange";
                    }

                    materials.forEach(m => {
                        let option = document.createElement('option');
                        option.value = m;
                        option.textContent = m;
                        select.appendChild(option);
                    });
                },
                error: function(xhr, status, error) {
                    console.error("âŒ ä¸Šå‚³å¤±æ•—:", error);
                    document.getElementById('uploadStatus').textContent = "âŒ ä¸Šå‚³å¤±æ•—ï¼š" + error;
                    document.getElementById('uploadStatus').style.color = "red";
                }
            });
        }

        function matchMaterial() {
            let input = document.getElementById('materialInput').value;
            
            fetch('http://127.0.0.1:5000/match', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ material: input })
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ” åŒ¹é…çµæœ:", data);
                let select = document.getElementById('materialSelect');
                select.innerHTML = '';
                data.matched.forEach(m => {
                    let option = document.createElement('option');
                    option.value = m;
                    option.textContent = m;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error("âŒ åŒ¹é…éŒ¯èª¤:", error);
            });
        }

        function calculateTests() {
            let selectedMaterial = document.getElementById('materialSelect').value;
            
            fetch('http://127.0.0.1:5000/calculate', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ material: selectedMaterial })
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“Š æ¸¬è©¦è¨ˆç®—çµæœ:", data);
                let table = document.getElementById('testResults');
                table.innerHTML = '<tr><th>æ¸¬è©¦éƒ¨é–€</th><th>æ‰€éœ€æ¨£æ©Ÿæ•¸</th></tr>';
                for (let dept in data.test_counts) {
                    let row = `<tr><td>${dept}</td><td>${data.test_counts[dept]}</td></tr>`;
                    table.innerHTML += row;
                }
            })
            .catch(error => {
                console.error("âŒ è¨ˆç®—éŒ¯èª¤:", error);
            });
        }
    </script>
</body>
</html>
